name: ðŸ† Auto GitHub Achievement Generator

on:
  schedule:
    # Run every day at 9 AM UTC (can be adjusted)
    - cron: '0 9 * * *'
  
  workflow_dispatch:
    inputs:
      achievement_type:
        description: 'Which achievement to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - pull-shark
          - galaxy-brain

  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

env:
  GITHUB_USERNAME: ${{ github.repository_owner }}

jobs:
  generate-achievements:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸš€ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, using scripts directly"
        fi
        
    - name: ðŸ”§ Setup Environment
      run: |
        echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
        echo "GITHUB_USERNAME=${{ github.repository_owner }}" >> $GITHUB_ENV
        chmod +x scripts/*.js scripts/*.sh
        
    - name: ðŸ¦ˆ Generate Pull Shark Achievement
      if: ${{ github.event.inputs.achievement_type == 'pull-shark' || github.event.inputs.achievement_type == 'all' || github.event_name == 'schedule' }}
      run: node scripts/pullShark.js
      continue-on-error: true
      
    - name: â³ Wait Between Generators
      if: ${{ github.event.inputs.achievement_type == 'all' || github.event_name == 'schedule' }}
      run: sleep 30
      
    - name: ðŸŒŒ Generate Galaxy Brain Achievement
      if: ${{ github.event.inputs.achievement_type == 'galaxy-brain' || github.event.inputs.achievement_type == 'all' || github.event_name == 'schedule' }}
      run: node scripts/galaxyBrain.js
      continue-on-error: true
      
    - name: ðŸ“Š Update Achievement Progress
      run: |
        # Create or update progress file
        date_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        cat > achievements/progress.md << EOF
        # Achievement Generation Progress
        
        Last run: $date_time
        Triggered by: ${{ github.event_name }}
        
        ## ðŸŽ¯ Target Achievements:
        - ðŸ¦ˆ Pull Shark: Auto-generated PRs
        - ðŸŒŒ Galaxy Brain: Discussion Q&As created
        
        ## ðŸ“ˆ Activity Summary:
        - Repository: ${{ github.repository }}
        - Actor: ${{ github.actor }}
        - Run ID: ${{ github.run_id }}
        
        Check your profile: https://github.com/${{ github.repository_owner }}
        EOF
        
    - name: ðŸ’¾ Commit Progress Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add achievements/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ† Update achievement progress - $(date -u +%Y-%m-%d)"
          git push
        fi
      continue-on-error: true

  notification:
    needs: generate-achievements
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸŽ‰ Success Notification
      if: needs.generate-achievements.result == 'success'
      run: |
        echo "âœ… Achievement generation completed successfully!"
        echo "ðŸ”— Check your profile: https://github.com/${{ github.repository_owner }}"
        
    - name: âš ï¸ Failure Notification
      if: needs.generate-achievements.result == 'failure'
      run: |
        echo "âŒ Achievement generation failed!"
        echo "ðŸ’¡ Check the logs for details"